<!DOCTYPE html>
<html>
  <head>
    <title>Geoblocking Test</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      h1 {
        color: #2c3e50;
        margin-top: 0;
      }
      .info-box {
        background: #f8f9fa;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin: 20px 0;
      }
      .status {
        padding: 10px 15px;
        border-radius: 4px;
        display: inline-block;
        font-weight: bold;
      }
      .enabled {
        background: #d4edda;
        color: #155724;
      }
      .disabled {
        background: #f8d7da;
        color: #721c24;
      }
      .toggle-container {
        margin: 20px 0;
        padding: 15px;
        background: #f0f8ff;
        border-radius: 8px;
      }
      .toggle-button {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
      }
      .test-button {
        padding: 10px 15px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Geoblocking Test</h1>
      
      <div class="info-box">
        <h2>Current Settings</h2>
        <div id="settings-info">Loading...</div>
      </div>
      
      <div class="toggle-container">
        <h3>Geoblocking Controls</h3>
        <p>Toggle geoblocking to restrict access to Greek IPs only:</p>
        <button id="toggle-button" class="toggle-button">Toggle Geoblocking</button>
        <div id="toggle-status" class="mt-2"></div>
        
        <h4 class="mt-4">IP Allowlist</h4>
        <p>Add specific IPs that should be allowed regardless of country:</p>
        <input type="text" id="ip-input" placeholder="Enter IP address" style="padding: 8px; width: 70%; margin-right: 10px;">
        <button id="add-ip-button" class="toggle-button" style="padding: 8px 15px;">Add IP</button>
        
        <div id="ip-list" class="mt-3">
          <p><strong>Current Allowlist:</strong></p>
          <ul id="allowed-ips"></ul>
        </div>
      </div>
      
      <div class="info-box">
        <h3>Test Your Connection</h3>
        <p>Click the button below to test if your current IP would be allowed:</p>
        <button id="test-button" class="test-button">Test My Connection</button>
        <div id="test-result" class="mt-3"></div>
      </div>
    </div>

    <script>
      // Function to load current settings
      async function loadSettings() {
        try {
          const response = await fetch('/api/geoblocking-status');
          if (!response.ok) {
            throw new Error('Failed to fetch geoblocking status');
          }
          
          const data = await response.json();
          updateSettingsDisplay(data);
        } catch (error) {
          console.error('Error loading settings:', error);
          document.getElementById('settings-info').innerHTML = 
            `<p class="text-danger">Error loading settings: ${error.message}</p>`;
        }
      }
      
      // Function to update the settings display
      function updateSettingsDisplay(data) {
        const settingsInfo = document.getElementById('settings-info');
        const statusClass = data.enabled ? 'enabled' : 'disabled';
        const statusText = data.enabled ? 'ENABLED' : 'DISABLED';
        
        settingsInfo.innerHTML = `
          <p><strong>Geoblocking Status:</strong> 
            <span class="status ${statusClass}">${statusText}</span>
          </p>
          <p><strong>Your IP Address:</strong> ${data.clientIp}</p>
          <p><strong>Your Country:</strong> ${data.country}</p>
          <p><strong>Is Greek IP:</strong> ${data.isGreekIp ? 'Yes' : 'No'}</p>
          <p><strong>In Allowlist:</strong> ${data.inAllowlist ? 'Yes' : 'No'}</p>
          <p><strong>Access Status:</strong> ${data.accessAllowed ? '<span style="color: green;">Allowed</span>' : '<span style="color: red;">Blocked</span>'}</p>
        `;
        
        // Update toggle button text
        document.getElementById('toggle-button').textContent = 
          data.enabled ? 'Disable Geoblocking' : 'Enable Geoblocking';
          
        // Update allowed IPs list
        const allowedIpsList = document.getElementById('allowed-ips');
        allowedIpsList.innerHTML = '';
        
        if (data.allowedIPs && data.allowedIPs.length) {
          data.allowedIPs.forEach(ip => {
            const li = document.createElement('li');
            li.textContent = ip;
            
            const removeButton = document.createElement('button');
            removeButton.textContent = 'Remove';
            removeButton.className = 'remove-ip';
            removeButton.style.marginLeft = '10px';
            removeButton.style.padding = '2px 5px';
            removeButton.style.backgroundColor = '#dc3545';
            removeButton.style.color = 'white';
            removeButton.style.border = 'none';
            removeButton.style.borderRadius = '3px';
            removeButton.style.cursor = 'pointer';
            
            removeButton.onclick = () => removeIp(ip);
            
            li.appendChild(removeButton);
            allowedIpsList.appendChild(li);
          });
        } else {
          allowedIpsList.innerHTML = '<li>No IPs in allowlist</li>';
        }
      }
      
      // Function to toggle geoblocking
      async function toggleGeoblocking() {
        try {
          document.getElementById('toggle-status').textContent = 'Updating...';
          
          const response = await fetch('/api/toggle-geoblocking', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error('Failed to toggle geoblocking');
          }
          
          const data = await response.json();
          document.getElementById('toggle-status').textContent = 
            `Geoblocking ${data.enabled ? 'enabled' : 'disabled'} successfully`;
          
          // Reload settings
          loadSettings();
        } catch (error) {
          console.error('Error toggling geoblocking:', error);
          document.getElementById('toggle-status').textContent = 
            `Error: ${error.message}`;
        }
      }
      
      // Function to add IP to allowlist
      async function addIp() {
        const ipInput = document.getElementById('ip-input');
        const ip = ipInput.value.trim();
        
        if (!ip) {
          alert('Please enter an IP address');
          return;
        }
        
        // Basic IP validation
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(ip)) {
          alert('Please enter a valid IP address');
          return;
        }
        
        try {
          const response = await fetch('/api/add-allowed-ip', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ip })
          });
          
          if (!response.ok) {
            throw new Error('Failed to add IP to allowlist');
          }
          
          // Clear input and reload settings
          ipInput.value = '';
          loadSettings();
        } catch (error) {
          console.error('Error adding IP:', error);
          alert(`Error adding IP: ${error.message}`);
        }
      }
      
      // Function to remove IP from allowlist
      async function removeIp(ip) {
        if (!confirm(`Remove ${ip} from allowlist?`)) {
          return;
        }
        
        try {
          const response = await fetch('/api/remove-allowed-ip', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ ip })
          });
          
          if (!response.ok) {
            throw new Error('Failed to remove IP from allowlist');
          }
          
          // Reload settings
          loadSettings();
        } catch (error) {
          console.error('Error removing IP:', error);
          alert(`Error removing IP: ${error.message}`);
        }
      }
      
      // Function to test connection
      async function testConnection() {
        try {
          document.getElementById('test-result').innerHTML = '<p>Testing your connection...</p>';
          
          const response = await fetch('/api/test-geoblocking');
          if (!response.ok) {
            throw new Error('Failed to test connection');
          }
          
          const data = await response.json();
          
          let resultHtml = '<h4>Test Results:</h4>';
          resultHtml += `<p><strong>Your IP:</strong> ${data.ip}</p>`;
          resultHtml += `<p><strong>Country:</strong> ${data.country}</p>`;
          
          if (data.accessAllowed) {
            resultHtml += `<p style="color: green; font-weight: bold;">Your IP would be ALLOWED to access the system</p>`;
            resultHtml += `<p>Reason: ${data.reason}</p>`;
          } else {
            resultHtml += `<p style="color: red; font-weight: bold;">Your IP would be BLOCKED from accessing the system</p>`;
            resultHtml += `<p>Reason: ${data.reason}</p>`;
          }
          
          document.getElementById('test-result').innerHTML = resultHtml;
        } catch (error) {
          console.error('Error testing connection:', error);
          document.getElementById('test-result').innerHTML = 
            `<p style="color: red;">Error testing connection: ${error.message}</p>`;
        }
      }
      
      // Add event listeners
      document.addEventListener('DOMContentLoaded', () => {
        // Load initial settings
        loadSettings();
        
        // Set up button handlers
        document.getElementById('toggle-button').addEventListener('click', toggleGeoblocking);
        document.getElementById('add-ip-button').addEventListener('click', addIp);
        document.getElementById('test-button').addEventListener('click', testConnection);
        
        // Add keypress handler for IP input
        document.getElementById('ip-input').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            addIp();
          }
        });
      });
    </script>
  </body>
</html>